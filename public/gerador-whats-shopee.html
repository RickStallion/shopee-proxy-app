<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerador Whats â€” Shopee Afiliado</title>
  <style>
    :root{--rosa:#E91E63;--borda:#e5e7eb}
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#fafafa;margin:0;padding:24px;color:#111}
    h1{margin:0 0 8px}
    .card{background:#fff;border:1px solid var(--borda);border-radius:14px;padding:16px;box-shadow:0 10px 20px rgba(0,0,0,.05)}
    .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    .muted{opacity:.75}
    button{background:var(--rosa);color:#fff;border:0;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    input,textarea{width:100%;border:1px solid var(--borda);border-radius:10px;padding:10px}
    .ok{color:#0a8f2e}
    .erro{color:#b91c1c}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
  </style>
</head>
<body>
  <h1>ðŸŸ£ Gerador Whats â€” Shopee</h1>
  <p class="muted">Cole seu link de afiliado da Shopee. O texto usa <b>exatamente</b> o seu link.</p>

  <div class="card">
    <label>Endpoint (Turbo â€” headless)</label>
    <input id="endpoint" value="/api/scrape-headless" />

    <label class="mt">Endpoint (RÃ¡pido â€” simples)</label>
    <input id="epSimple" value="/api/scrape" />

    <label>Token (ACCESS_TOKEN)</label>
    <input id="token" placeholder="ex.: token842723" />

    <div style="margin-top:8px"><button onclick="saveCfg()">Salvar config</button></div>
    <p class="muted">Config fica salva no navegador.</p>
  </div>

  <br/>
  <div class="card">
    <label>Link de afiliado Shopee</label>
    <input id="link" placeholder="https://s.shopee.com.br/... ou https://shopee.com.br/..." />

    <div class="row" style="margin-top:8px">
      <button onclick="buscarDados()">Buscar dados</button>
      <button style="background:#111" onclick="limpar()">Limpar</button>
    </div>

    <p id="status" class="muted" style="margin-top:6px">&nbsp;</p>

    <div class="row" id="resultado" style="display:none; margin-top:10px">
      <div>
        <small class="muted">Link (afiliado):</small>
        <div class="mono" id="resLink"></div>
        <small class="muted">finalUrl:</small>
        <div class="mono" id="resFinal"></div>
        <small class="muted">Imagem:</small>
        <div class="mono" id="resImg"></div>
      </div>
      <div>
        <label>TÃ­tulo do produto</label>
        <input id="titulo" />
        <div class="row">
          <div>
            <label>PreÃ§o DE</label>
            <input id="precoDe" />
          </div>
          <div>
            <label>PreÃ§o POR</label>
            <input id="precoPor" />
          </div>
        </div>
        <label>Texto pronto (WhatsApp)</label>
        <textarea id="txt" rows="8"></textarea>
        <div style="margin-top:8px" class="row">
          <button onclick="copiar()">Copiar texto</button>
          <button onclick="baixarImagem()">Baixar imagem</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const el = (id)=>document.getElementById(id);

    (function load(){
      el('endpoint').value  = localStorage.getItem('epHeadless') || '/api/scrape-headless';
      el('epSimple').value  = localStorage.getItem('epSimple') || '/api/scrape';
      el('token').value     = localStorage.getItem('epToken') || '';
      el('status').innerText = '';
    })();

    function saveCfg(){
      localStorage.setItem('epHeadless', el('endpoint').value.trim());
      localStorage.setItem('epSimple', el('epSimple').value.trim());
      localStorage.setItem('epToken', el('token').value.trim());
      el('status').innerText = 'Config salva.';
    }

    function limpar(){
      el('link').value = '';
      el('resultado').style.display = 'none';
      el('status').innerText = '';
    }

    async function buscarDados(){
      const epTurbo  = el('endpoint').value.trim();
      const epRapido = el('epSimple').value.trim();
      const token    = el('token').value.trim();
      const link     = el('link').value.trim();
      const statusEl = el('status');

      statusEl.className = 'muted';
      statusEl.innerText = 'Buscando dados...';

      async function chama(ep){
        const ctrl = new AbortController();
        const tid = setTimeout(()=>ctrl.abort(), 15000);
        try{
          const res = await fetch(`${ep}?u=${encodeURIComponent(link)}`,{
            signal: ctrl.signal,
            headers: token ? { Authorization: 'Bearer ' + token } : {}
          });
          clearTimeout(tid);
          if(!res.ok){
            const txt = await res.text().catch(()=> '');
            throw new Error(`Proxy ${res.status} ${res.statusText}${txt? ' - '+txt: ''}`);
          }
          const json = await res.json().catch(()=> ({}));
          return json;
        }catch(e){ clearTimeout(tid); throw e; }
      }

      try{
        let data = await chama(epRapido);
        if(!data || (!data.title && !data.price && !data.image)){
          data = await chama(epTurbo);
        }
        if(!data) throw new Error('Sem dados do proxy');
        preencher(data, link);
        statusEl.className = 'ok';
        statusEl.innerText = 'Pronto! Copie e cole no WhatsApp.';
      }catch(e){
        statusEl.className = 'erro';
        statusEl.innerText = 'Erro: ' + (e.message || e);
      }
    }

    function preencher(d, affiliate){
      el('resultado').style.display = 'grid';
      el('resLink').innerText = affiliate;
      el('resFinal').innerText = d.finalUrl || '';
      el('resImg').innerText = d.image || '';
      el('titulo').value = d.title || '';
      const p = (d.price||'').replace(/\n+/g,' ').trim();
      el('precoPor').value = p;
      el('txt').value = templateWhats({ title: d.title, price: p, affiliate });
    }

    function templateWhats({title, price, affiliate}){
      const linhas = [];
      linhas.push((title||'Oferta Shopee').toUpperCase());
      if(price) linhas.push('ðŸ”– ' + price);
      linhas.push('');
      linhas.push('ðŸ›’ compre aqui:' + affiliate);
      linhas.push('');
      linhas.push('#ShopeeAchados #OfertasShopee #PromoShopee #CasaBonita #DecoraÃ§Ã£o');
      return linhas.join('\n');
    }

    function copiar(){
      navigator.clipboard.writeText(el('txt').value).then(()=>alert('Copiado!'));
    }

    function baixarImagem(){
      const src = el('resImg').innerText.trim();
      if(!src) return alert('Sem imagem vinda do proxy.');
      const a = document.createElement('a');
      a.href = src; a.download = 'produto.jpg';
      document.body.appendChild(a); a.click(); a.remove();
    }
  </script>
</body>
</html>
